{% extends 'storage/base.html' %}
{% load static %}

{% block content %}
<!-- 存储空间使用情况概览 -->
<div class="storage-info fade-in">
    <div class="storage-stats">
        <div class="storage-stat">
            <div class="storage-stat-value" id="file-count-display">{{ file_count }}</div>
            <div class="storage-stat-label">个文件</div>
        </div>
        <div class="storage-stat">
            <div class="storage-stat-value" id="total-size-display">{{ storage_info.formatted_current }}</div>
            <div class="storage-stat-label">已使用</div>
        </div>
        <div class="storage-stat">
            <div class="storage-stat-value" id="max-size-display">{{ storage_info.formatted_max }}</div>
            <div class="storage-stat-label">总容量</div>
        </div>
        <div class="storage-stat">
            <div class="storage-stat-value" id="available-size-display">{{ storage_info.formatted_available }}</div>
            <div class="storage-stat-label">可用空间</div>
        </div>
    </div>
    <div class="mt-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <small class="text-white-50">存储使用率</small>
            <small class="text-white-50" id="usage-percent">
                {{ storage_info.usage_percentage|floatformat:1 }}%
            </small>
        </div>
        <div class="progress" style="height: 6px; background: rgba(255,255,255,0.2);">
            <div class="progress-bar" id="storage-usage-bar" 
                 style="width: {{ storage_info.usage_percentage }}%; 
                        background: {% if storage_info.is_full %}#dc3545{% elif storage_info.is_nearly_full %}#ffc107{% else %}rgba(255,255,255,0.8){% endif %};"></div>
        </div>
        {% if storage_info.is_full %}
        <div class="alert alert-danger mt-2 mb-0" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            存储空间已满！请删除一些文件后再上传。
        </div>
        {% elif storage_info.is_nearly_full %}
        <div class="alert alert-warning mt-2 mb-0" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            存储空间即将用完，剩余 {{ storage_info.formatted_available }}。
        </div>
        {% endif %}
    </div>
</div>

<!-- 文件上传功能区域 -->
<div class="card mb-4 slide-up">
    <div class="card-header">
        <h5 class="card-title">
            <i class="fas fa-cloud-upload-alt text-primary me-2"></i>文件上传
        </h5>
    </div>
    <div class="card-body">
        <!-- 拖拽文件上传区域 -->
        <div id="upload-zone" class="upload-zone">
            <div id="upload-zone-content" class="upload-zone-content">
                <div class="upload-zone-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h5 class="upload-zone-title">拖拽文件到此处上传</h5>
                <p class="upload-zone-subtitle">或者点击选择文件，支持多文件同时上传</p>
                <button type="button" class="btn btn-primary btn-lg" id="select-files-btn">
                    <i class="fas fa-folder-open me-2"></i>选择文件
                </button>
            </div>
            <input type="file" id="file-input" multiple class="d-none">
        </div>

        <!-- 待上传文件预览区域 -->
        <div id="file-preview" class="file-preview d-none">
            <h6 class="mb-3">
                <i class="fas fa-files me-2"></i>待上传文件
                <span class="badge bg-primary ms-2" id="preview-count">0</span>
            </h6>
            <div id="preview-list"></div>
            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="clear-preview">
                <i class="fas fa-times me-1"></i>清除选择
            </button>
        </div>

        <!-- 上传操作控制区域 -->
        <div class="row mt-3">
            <div class="col-md-8">
                <input type="text" id="file-description" class="form-control" 
                       placeholder="可选：为文件添加描述信息">
            </div>
            <div class="col-md-4">
                <button type="button" id="upload-btn" class="btn btn-success w-100" disabled>
                    <i class="fas fa-upload me-2"></i>开始上传
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 文件上传进度显示模态框 -->
<div id="upload-progress-modal" class="upload-progress d-none">
    <div class="upload-progress-icon">
        <i class="fas fa-cloud-upload-alt"></i>
    </div>
    <h5>正在上传文件...</h5>
    <p class="upload-progress-text">请稍候，文件正在上传中</p>
    <div class="upload-progress-bar">
        <div class="upload-progress-fill" style="width: 0%"></div>
    </div>
    <div class="upload-progress-info">
        <div class="progress-info-item">
            <span class="info-label">传输速度：</span>
            <span id="upload-speed" class="info-value">0 KB/s</span>
        </div>
        <div class="progress-info-item">
            <span class="info-label">剩余时间：</span>
            <span id="upload-time" class="info-value">计算中...</span>
        </div>
        <div class="progress-info-item">
            <span class="info-label">已传大小：</span>
            <span id="upload-size" class="info-value">0 B / 0 B</span>
        </div>
    </div>
</div>

<!-- 文件管理操作工具栏 -->
<div class="file-toolbar slide-up">
    <div class="row align-items-center">
        <div class="col-md-4">
            <div class="view-toggle">
                <button type="button" id="view-grid" class="btn active">
                    <i class="fas fa-th me-1"></i>图标视图
                </button>
                <button type="button" id="view-list" class="btn">
                    <i class="fas fa-list me-1"></i>列表视图
                </button>
            </div>
        </div>
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" id="search-input" class="form-control" placeholder="搜索文件...">
            </div>
        </div>
        <div class="col-md-4 text-end">
            <button type="button" id="select-all" class="btn btn-outline-secondary me-2">
                <i class="fas fa-check-square me-1"></i>全选
            </button>
            <button type="button" id="delete-selected" class="btn btn-outline-danger" disabled>
                <i class="fas fa-trash me-1"></i>删除选中
            </button>
        </div>
    </div>
</div>

<!-- 文件列表展示区域 -->
<div class="card scale-in">
    <div class="card-header">
        <h5 class="card-title">
            <i class="fas fa-folder-open text-warning me-2"></i>我的文件
            <span class="badge bg-primary ms-2" id="file-count-badge">{{ files.count }}</span>
        </h5>
    </div>
    <div class="card-body p-0">
        <!-- 文件网格图标视图 -->
        <div id="grid-view">
            {% if files %}
                <div class="file-grid" id="file-grid">
                    {% for file in files %}
                    <div class="file-card bounce-in" data-file-id="{{ file.id }}" style="animation-delay: {{ forloop.counter0|floatformat:1|add:"0.1" }}s">
                        <input type="checkbox" class="file-checkbox">
                        <div class="file-icon">
                            <i class="{{ file.get_icon_class }}"></i>
                        </div>
                        <div class="file-name" title="{{ file.get_filename }}">
                            {{ file.get_filename }}
                        </div>
                        <div class="file-size">{{ file.get_formatted_size }}</div>
                        <div class="file-actions">
                            <button type="button" class="btn btn-sm btn-outline-success" 
                                    onclick="fileManager.downloadFileWithSpeed('{{ file.file.url }}', '{{ file.get_filename }}')" 
                                    title="下载">
                                <i class="fas fa-download"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-file" 
                                    data-file-id="{{ file.id }}" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h5 class="empty-state-title">还没有上传任何文件</h5>
                    <p class="empty-state-description">开始上传您的第一个文件吧！</p>
                </div>
            {% endif %}
        </div>

        <!-- 文件详细列表视图 -->
        <div id="list-view" class="d-none">
            {% if files %}
                <div class="file-list">
                    <div class="file-list-header">
                        <div style="display: grid; grid-template-columns: 40px 1fr 100px 80px 120px 150px 100px; align-items: center;">
                            <input type="checkbox" id="select-all-list">
                            <span data-sort="name" style="cursor: pointer;">文件名</span>
                            <span data-sort="size" style="cursor: pointer;">大小</span>
                            <span data-sort="type" style="cursor: pointer;">类型</span>
                            <span data-sort="date" style="cursor: pointer;">上传时间</span>
                            <span>描述</span>
                            <span>操作</span>
                        </div>
                    </div>
                    {% for file in files %}
                    <div class="file-list-item" data-file-id="{{ file.id }}">
                        <input type="checkbox" class="file-list-checkbox">
                        <div class="file-list-name">
                            <i class="{{ file.get_icon_class }} file-list-icon"></i>
                            <span title="{{ file.get_filename }}">{{ file.get_filename }}</span>
                        </div>
                        <div class="file-list-size">{{ file.get_formatted_size }}</div>
                        <div class="file-list-type">{{ file.get_file_extension|upper }}</div>
                        <div class="file-list-date">{{ file.uploaded_at|date:"m-d H:i" }}</div>
                        <div class="file-list-description" title="{{ file.description }}">
                            {{ file.description|default:"无描述" }}
                        </div>
                        <div class="file-list-actions">
                            <button type="button" class="btn btn-sm btn-outline-success" 
                                    onclick="fileManager.downloadFileWithSpeed('{{ file.file.url }}', '{{ file.get_filename }}')" 
                                    title="下载">
                                <i class="fas fa-download"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-file" 
                                    data-file-id="{{ file.id }}" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h5 class="empty-state-title">还没有上传任何文件</h5>
                    <p class="empty-state-description">开始上传您的第一个文件吧！</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/upload-manager.js' %}"></script>
<script src="{% static 'js/file-grid.js' %}"></script>
<script src="{% static 'js/file-list.js' %}"></script>
<script src="{% static 'js/file-manager.js' %}"></script>
{% endblock %}